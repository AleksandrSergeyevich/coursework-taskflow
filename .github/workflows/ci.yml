name: CI Pipeline for TaskFlow

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # –£–î–ê–õ–Ø–ï–ú –±–ª–æ–∫ "Build and test backend" ‚Äî –æ–Ω –Ω–∞–º –Ω–µ –Ω—É–∂–µ–Ω!

    - name: Build frontend
      run: |
        echo "üì¶ Building frontend image..."
        cd frontend
        docker build -t taskflow-frontend .
        echo "‚úÖ Frontend image built successfully"

    - name: Run full system with Docker Compose
      run: |
        echo "üê≥ Starting full system with Docker Compose..."
        docker compose up -d

        echo "‚è≥ Waiting 60 seconds for all services to initialize..."
        sleep 60  # –î–∞—ë–º –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ ‚Äî GitHub Actions –º–µ–¥–ª–µ–Ω–Ω–µ–µ

        echo "‚úÖ Checking backend health (/health)..."
        if curl -f http://localhost:5000/health; then
          echo "üíö Backend is responding"
        else
          echo "‚ùå Backend is NOT responding"
          docker compose logs backend
          exit 1
        fi

        echo "‚úÖ Checking frontend availability..."
        if curl -f http://localhost:8080; then
          echo "üíö Frontend is responding"
        else
          echo "‚ùå Frontend is NOT responding"
          docker compose logs frontend
          exit 1
        fi

        echo "‚úÖ FULL SYSTEM IS RUNNING SUCCESSFULLY!"
        echo "üõë Stopping all containers..."
        docker compose down
